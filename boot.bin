; Will add jmp to kernel when I write it, Im in no rush to finish this right now
; This boots into 32 bit protected mode and prints
; Next step is embedding a kernel and jmp to it easy stuff

org 0x7C00

cli
cld

; Enable A20
in   al, 0x92
or   al, 2
out  0x92, al

; Load GDT
lgdt [gdtr]

mov ah, 0x00
mov al, 0x03
int 0x10

; Enter protected mode
mov eax, cr0
or  eax, 1
mov cr0, eax

jmp 0x08:pm_entry

; ---------------------
; 32-bit protected mode
; ---------------------
[bits 32]
pm_entry:
    mov ax, 0x10
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    mov ss, ax
    mov esp, 0x9FC00

    mov ax, 0x10
    mov ds, ax

mov word [0xB8000], 0x0753   ; 'S'
mov word [0xB8002], 0x074C   ; 'L'
mov word [0xB8004], 0x0745   ; 'E'
mov word [0xB8006], 0x0745   ; 'E'
mov word [0xB8008], 0x0750   ; 'P'

hang: jmp hang

; ---------------------
; GDT
; ---------------------
[bits 16]
gdt_start:
    dq 0x0000000000000000
    dq 0x00CF9A000000FFFF   ; code segment: base=0, limit=4GB
    dq 0x00CF92000000FFFF   ; data segment: base=0, limit=4GB
gdt_end:

gdtr:
    dw gdt_end - gdt_start - 1
    dd gdt_start

times 510-($-$$) db 0
dw 0xAA55
